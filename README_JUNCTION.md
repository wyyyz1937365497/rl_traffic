# 路口级多智能体交通控制系统

## 核心设计理念

基于您的观察和建议，本系统采用**路口级多智能体架构**，将每个关键路口作为独立智能体，针对不同拓扑类型设计专门的状态空间和策略网络。

## 架构优势

### 1. 降低状态空间维度
- **原方案**: 全局状态（所有车辆 + 所有道路）→ 维度爆炸
- **新方案**: 路口局部状态（主路车辆 + 匝道车辆）→ 维度可控

### 2. 精准建模冲突点
- 拥堵主要来源于路口汇入冲突
- 每个路口独立建模，聚焦核心问题
- 状态表示更精准，决策更清晰

### 3. 拓扑类型专门化
- **类型A**: 单纯匝道汇入 → 主路让行 + 匝道汇入时机
- **类型B**: 匝道汇入+主路转出 → 协调汇入与转出

### 4. 路口间协调
- 相邻路口通过注意力机制协调
- 避免局部最优，实现全局优化

## 路网拓扑分析

### 关键路口识别

```
J5 (类型A) ──→ J14 (类型A) ──→ J15 (类型B) ──→ J17 (类型B)
  │                │                │                │
匝道E23汇入     匝道E15汇入     匝道E17汇入      匝道E19汇入
                                  主路转E16       主路转E18/E20
```

### 路口类型详解

#### 类型A：单纯匝道汇入（J5, J14）

```
      ┌──────────┐
      │   主路   │
      │  ────→   │
      └──────────┘
           ↑
      ┌────┴────┐
      │  匝道   │
      │  ────→   │
      └─────────┘
```

**关键决策**:
1. 主路CV车辆是否减速让行
2. 匝道CV车辆何时加速汇入
3. 汇入间隙选择

**状态空间** (16维):
- 主路车辆数、速度、密度、排队长度
- 匝道车辆数、速度、排队长度、等待时间
- 信号灯相位、切换时间
- 冲突风险、可接受间隙
- CV车辆比例

**动作空间** (3维):
- 主路CV控制（速度比例）
- 匝道CV控制（速度比例）
- 汇入时机选择

#### 类型B：匝道汇入 + 主路转出（J15, J17）

```
      ┌──────────┐
      │   主路   │
      │  ────→ ──┼──→ 转出匝道
      └──────────┘
           ↑
      ┌────┴────┐
      │  匝道   │
      │  ────→   │
      └─────────┘
```

**关键决策**:
1. 主路CV车辆让行策略
2. 匝道CV车辆汇入时机
3. **转出车辆与汇入车辆的协调**
4. 转出引导（帮助转出车辆选择时机）

**状态空间** (16维 + 转出特征):
- 类型A的所有特征
- 转出车辆数、排队长度

**动作空间** (4维):
- 主路CV控制
- 匝道CV控制
- 转出引导
- 协调策略

## 神经网络架构

### 类型A策略网络

```
状态编码器 (MLP)
      ↓
车辆编码器 (主路 + 匝道)
      ↓
空间注意力 (捕捉主路-匝道关系)
      ↓
┌─────────────┬─────────────┐
│  冲突预测器  │  间隙预测器  │
└─────────────┴─────────────┘
      ↓
┌─────────────┬─────────────┐
│ 主路控制头  │  匝道控制头  │
└─────────────┴─────────────┘
      ↓
    价值头
```

### 类型B策略网络

```
状态编码器 (MLP)
      ↓
车辆编码器 (主路 + 匝道 + 转出)
      ↓
三方注意力 (主路-匝道-转出)
      ↓
┌──────────────┬──────────────┐
│ 汇入冲突预测 │ 转出冲突预测 │
└──────────────┴──────────────┘
      ↓
协调模块 (汇入-转出协调)
      ↓
┌─────────────┬─────────────┬─────────────┐
│ 主路控制头  │ 匝道控制头  │ 转出引导头  │
└─────────────┴─────────────┴─────────────┘
      ↓
    价值头
```

### 路口间协调模块

```
J5特征 ←→ J14特征 ←→ J15特征 ←→ J17特征
   ↓          ↓          ↓          ↓
路口间注意力 (基于邻接关系)
   ↓          ↓          ↓          ↓
协调特征 → 全局价值网络
```

## 文件结构

```
rl_traffic/
├── junction_agent.py      # 路口智能体定义
├── junction_network.py    # 路口级神经网络
├── junction_trainer.py    # 多智能体PPO训练器
├── junction_main.py       # 主入口
└── README_JUNCTION.md     # 本文件
```

## 使用方法

### 1. 查看路口信息

```bash
python junction_main.py info
```

输出:
```
【J5】- 类型: type_a
  主路入边: ['E2']
  主路出边: ['E3']
  匝道入边: ['E23']
  >>> 单纯匝道汇入：控制主路让行 + 匝道汇入时机

【J15】- 类型: type_b
  主路入边: ['E10']
  主路出边: ['E11']
  匝道入边: ['E17']
  匝道出边: ['E16']
  >>> 匝道汇入+主路转出：协调汇入与转出
```

### 2. 训练模型

```bash
# 基础训练
python junction_main.py train --total-timesteps 1000000

# 带评估的训练
python junction_main.py train --total-timesteps 1000000 --eval

# 使用GUI观察
python junction_main.py train --gui
```

### 3. 评估模型

```bash
python junction_main.py eval --model checkpoints_junction/best_model.pt --episodes 10
```

### 4. 运行推理

```bash
python junction_main.py infer --model checkpoints_junction/best_model.pt
```

### 5. 运行基线对比

```bash
python junction_main.py baseline
```

## 关键设计要点

### 1. 为什么分路口处理？

**问题**: 全局状态空间维度爆炸
- 200辆车 × 15特征 = 3000维
- 难以训练，难以泛化

**解决**: 路口局部状态
- 每个路口: ~20辆车 × 8特征 = 160维
- 维度可控，训练稳定

### 2. 为什么区分拓扑类型？

**观察**: 不同拓扑的决策逻辑不同
- 类型A: 只需考虑汇入冲突
- 类型B: 需要协调汇入和转出

**实现**: 专门化的网络结构
- 类型A: 双方注意力（主路-匝道）
- 类型B: 三方注意力（主路-匝道-转出）+ 协调模块

### 3. 如何处理路口间协调？

**方法**: 基于邻接关系的注意力
- J5 → J14 → J15 → J17
- 相邻路口交换信息
- 避免局部最优

### 4. 状态表示为什么这样设计？

**原则**: 只包含决策相关信息
- **主路状态**: 判断是否需要让行
- **匝道状态**: 判断汇入时机
- **信号灯状态**: 考虑相位影响
- **冲突风险**: 核心决策依据
- **CV车辆**: 可控制的车辆

### 5. 动作空间为什么这样设计？

**原则**: 直接控制关键变量
- **主路CV**: 速度控制（让行/不让行）
- **匝道CV**: 速度控制（加速汇入/等待）
- **转出引导**: 帮助转出车辆选择时机

## 训练技巧

### 1. 课程学习
```python
# 阶段1: 单路口训练
train_single_junction('J5', steps=100000)

# 阶段2: 双路口协调
train_two_junctions(['J5', 'J14'], steps=200000)

# 阶段3: 全路口联合
train_all_junctions(['J5', 'J14', 'J15', 'J17'], steps=500000)
```

### 2. 奖励设计
```python
# 路口级奖励
reward = (
    -queue_length * 0.1          # 排队惩罚
    -waiting_time * 0.05         # 等待惩罚
    -conflict_risk * 0.5         # 冲突风险惩罚
    +gap_acceptance * 0.2        # 间隙利用奖励
    -speed_variance * 0.02       # 速度稳定性
)
```

### 3. 探索策略
- 初始高熵系数: 0.01
- 逐步衰减: 0.999
- 最小值: 0.001

## 与原方案对比

| 维度 | 原方案（全局） | 新方案（路口级） |
|------|---------------|-----------------|
| 状态维度 | ~3000维 | ~160维/路口 |
| 动作空间 | 所有CV车辆 | 关键路口CV |
| 建模精度 | 粗粒度 | 精细到冲突点 |
| 训练难度 | 高 | 中 |
| 可解释性 | 低 | 高 |
| 泛化能力 | 低 | 高（同类型路口共享策略） |

## 预期效果

1. **训练效率提升**: 状态空间降低，收敛更快
2. **决策质量提升**: 聚焦冲突点，决策更精准
3. **可解释性提升**: 每个路口的决策逻辑清晰
4. **泛化能力提升**: 同类型路口可共享策略

## 下一步改进

1. **层次化强化学习**: 上层协调，下层执行
2. **图神经网络**: 更好地建模路口间关系
3. **元学习**: 快速适应新路口
4. **迁移学习**: 从简单路口迁移到复杂路口

## 注意事项

1. 初赛阶段只关注OCR
2. 不能修改信号灯配置
3. 只能控制CV类型车辆
4. 需要考虑路口间的协调

## 联系方式

如有问题，请查看代码注释或提交issue。
