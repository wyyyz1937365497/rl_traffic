# PPOå¾®è°ƒå¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸ¯ å¥–åŠ±å‡½æ•°è®¾è®¡

åŸºäºBCæ¨¡å‹OCRå·²è¾¾0.93çš„è§‚å¯Ÿï¼Œå¥–åŠ±å‡½æ•°ä¼˜å…ˆçº§è°ƒæ•´å¦‚ä¸‹ï¼š

### 1. â­ æµé‡å¥–åŠ±ï¼ˆæƒé‡: 4.5ï¼‰- æœ€é‡è¦

**ä¼˜å…ˆçº§åŸå› **ï¼šBCå·²æœ‰0.93 OCRï¼Œæµé‡æˆä¸ºæå‡åˆ†æ•°çš„å…³é”®

```python
# é€Ÿåº¦å¥–åŠ±ï¼ˆæƒé‡3.0ï¼‰
speed_reward = 3.0 * (mean_speed / 13.89) ** 2

# æ´»è·ƒè½¦è¾†å¥–åŠ±ï¼ˆæƒé‡1.5ï¼‰
traffic_reward = 1.5 * (num_active / 500.0)

throughput_reward = speed_reward + traffic_reward
```

- é€Ÿåº¦å¥–åŠ±ï¼šå¹³æ–¹é¡¹æ”¾å¤§é«˜é€Ÿè´¡çŒ®ï¼Œé¼“åŠ±ä¿æŒ13.89 m/sï¼ˆ50 km/hï¼‰
- æ´»è·ƒè½¦è¾†ï¼šç³»ç»Ÿå†…è¿è¡Œè½¦è¾†è¶Šå¤šè¶Šå¥½ï¼ˆç›®æ ‡500è¾†ï¼‰
- ç›´æ¥æå‡äº¤é€šååé‡

### 2. â­ ç¨³å®šæ€§å¥–åŠ±ï¼ˆæƒé‡: 3.0ï¼‰- ç¬¬äºŒä¼˜å…ˆ

```python
# é€Ÿåº¦ç¨³å®šæ€§ï¼ˆæƒé‡1.5ï¼‰
stability_speed = 1.5 * max(0, 1.0 - speed_std / 6.0)  # ç›®æ ‡: < 6 m/s

# åŠ é€Ÿåº¦ç¨³å®šæ€§ï¼ˆæƒé‡1.5ï¼‰
stability_accel = 1.5 * max(0, 1.0 - mean_abs_accel / 1.0)  # ç›®æ ‡: < 1.0 m/sÂ²
```

- é€Ÿåº¦æ ‡å‡†å·®ç›®æ ‡ï¼š< 6 m/sï¼ˆæ›´ä¸¥æ ¼ï¼‰
- åŠ é€Ÿåº¦ç›®æ ‡ï¼š< 1.0 m/sÂ²ï¼ˆæ›´ä¸¥æ ¼ï¼‰
- å‡å°‘æ€¥åŠ å‡é€Ÿï¼Œæå‡èˆ’é€‚åº¦

### 3. OCRå¥–åŠ±ï¼ˆæƒé‡: 2.0ï¼‰- ç¬¬ä¸‰ä¼˜å…ˆ

**ä¸ºä»€ä¹ˆé™ä½æƒé‡**ï¼šBCå·²è¾¾0.93ï¼Œæå‡ç©ºé—´æœ‰é™

```python
if current_ocr >= 0.93:  # BCåŸºå‡†
    ocr_reward = 2.0 * ((current_ocr - 0.93) / (0.965 - 0.93)) ** 2
    ocr_reward = min(ocr_reward, 3.0)  # ä¸Šé™3.0
else:
    ocr_reward = 2.0 * (current_ocr / 0.93)
```

- ç›®æ ‡OCRï¼š0.965ï¼ˆæå‡åˆ°0.96-0.97èŒƒå›´ï¼‰
- åŸºå‡†ï¼š0.93ï¼ˆBCå·²æœ‰æ°´å¹³ï¼‰
- ä»…åœ¨è¶…è¿‡åŸºå‡†æ—¶ç»™äºˆé¢å¤–å¥–åŠ±

### 4. å®‰å…¨æ€§æƒ©ç½šï¼ˆæƒé‡: -2.5ï¼‰

```python
collision_penalty = -1.0 * num_collisions        # æ¯æ¬¡-1.0
emergency_stop_penalty = -0.2 * num_emergency_stops  # æ¯æ¬¡-0.2
slow_penalty = -1.5 * slow_ratio                 # é€Ÿåº¦<3m/sçš„è½¦è¾†æ¯”ä¾‹
jam_penalty = -0.5 * jam_ratio                   # é€Ÿåº¦<5m/sçš„è½¦è¾†æ¯”ä¾‹
```

- ç¢°æ’æƒ©ç½šå¢å¼ºï¼š-0.5 â†’ -1.0
- æ…¢é€Ÿæƒ©ç½šå¢å¼ºï¼š-1.0 â†’ -1.5
- æ–°å¢æ‹¥å µæƒ©ç½šï¼š-0.5

---

**è®¾è®¡ç†å¿µ**ï¼šæµé‡ > ç¨³å®šæ€§ > OCR > å®‰å…¨

---

## ğŸš€ å®Œæ•´è®­ç»ƒæµç¨‹

### æ­¥éª¤1: å‡†å¤‡BCæ¨¡å‹

å¦‚æœå·²æœ‰BCæ¨¡å‹ï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚å¦åˆ™ï¼š

```bash
python train_bc_full.py \
  --train-demos expert_demos_vehicle_v4 \
  --output-dir bc_pretrain \
  --control-weight 100 \
  --epochs 50 \
  --device cuda
```

### æ­¥éª¤2: PPOå¾®è°ƒï¼ˆæ ¸å¿ƒï¼‰

```bash
python train_ppo_finetune.py \
  --bc-checkpoint bc_pretrain/best_model.pt \
  --output-dir ppo_finetune_checkpoints \
  --log-dir ./logs/ppo_finetune \
  --episodes 100 \
  --max-steps 3600 \
  --lr 1e-5 \
  --device cuda \
  --seed 42
```

**å‚æ•°è¯´æ˜**ï¼š
- `--bc-checkpoint`: BCæ¨¡å‹è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
- `--episodes`: è®­ç»ƒepisodesæ•°ï¼ˆå»ºè®®100-200ï¼‰
- `--lr`: å­¦ä¹ ç‡ï¼ˆå¾®è°ƒå»ºè®®1e-5ï¼Œæ¯”BCå°100å€ï¼‰
- `--max-steps`: æ¯ä¸ªepisodeæœ€å¤§æ­¥æ•°ï¼ˆ3600=1å°æ—¶ä»¿çœŸï¼‰

**é¢„æœŸæ—¶é—´**ï¼š
- æ¯ä¸ªepisodeçº¦1-2åˆ†é’Ÿ
- 100 episodesçº¦2-3å°æ—¶ï¼ˆRTX 3090ï¼‰

### æ­¥éª¤3: ç›‘æ§è®­ç»ƒ

```bash
# å®æ—¶æ—¥å¿—
tail -f ./logs/ppo_finetune/finetune_*.log

# TensorBoardï¼ˆå¦å¼€ç»ˆç«¯ï¼‰
tensorboard --logdir ./logs/ppo_finetune
```

### æ­¥éª¤4: ç”Ÿæˆæäº¤

```bash
# ç­‰å¾…è®­ç»ƒå®Œæˆå
python generate_submit_bc.py \
  --checkpoint ppo_finetune_checkpoints/best_model.pt \
  --output submit_ppo_finetune.pkl

# æœ¬åœ°è¯„åˆ†
python local_score_calculator.py submit_ppo_finetune.pkl
```

---

## ğŸ“Š é¢„æœŸè¾“å‡º

### Episodeæ—¥å¿—ç¤ºä¾‹

```
[Episode] æ€»å¥–åŠ±: 3234.56
[Episode] å¹³å‡å¥–åŠ±åˆ†è§£ï¼ˆæµé‡ä¼˜å…ˆç‰ˆæœ¬ï¼‰:
  ã€æµé‡å¥–åŠ±ã€‘æ€»è®¡: 2.3456 â­      # ä¸»è¦è´¡çŒ®ï¼ˆé€Ÿåº¦+æ´»è·ƒè½¦è¾†ï¼‰
    - é€Ÿåº¦å¥–åŠ±: 1.8234
    - æ´»è·ƒè½¦è¾†: 0.5222
  ã€ç¨³å®šæ€§å¥–åŠ±ã€‘æ€»è®¡: 1.8765 â­
    - é€Ÿåº¦ç¨³å®šæ€§: 0.9456
    - åŠ é€Ÿåº¦ç¨³å®šæ€§: 0.9309
  ã€OCRå¥–åŠ±ã€‘: 1.2345            # ç¬¬ä¸‰ä¼˜å…ˆï¼ˆç›®æ ‡0.965ï¼‰
  ã€å®‰å…¨æ€§æƒ©ç½šã€‘: -0.5234
    - ç¢°æ’: -0.1000
    - æ€¥åœ: -0.0234
    - æ…¢é€Ÿ: -0.2500
    - æ‹¥å µ: -0.1500
```

### TensorBoardæ›²çº¿

- **Reward/total**: æ€»å¥–åŠ±æ›²çº¿ï¼ˆåº”ä¸Šå‡ï¼‰
- **Reward/mean**: å¹³å‡å¥–åŠ±ï¼ˆåº”ç¨³å®šï¼‰
- **Loss/policy**: ç­–ç•¥æŸå¤±ï¼ˆåº”ä¸‹é™ï¼‰
- **Loss/value**: ä»·å€¼æŸå¤±ï¼ˆåº”ä¸‹é™ï¼‰
- **Entropy**: ç†µï¼ˆæ¢ç´¢ç¨‹åº¦ï¼Œç¼“æ…¢ä¸‹é™ï¼‰

---

## ğŸ”§ è¶…å‚æ•°è°ƒä¼˜

### å¦‚æœå¥–åŠ±å¤ªä½ï¼ˆ< 1000ï¼‰

**å¯èƒ½åŸå› **ï¼šæ¨¡å‹ä¸æ§åˆ¶ï¼ŒOCRå¤ªä½

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢å¤§å­¦ä¹ ç‡ï¼ŒåŠ å¿«è®­ç»ƒ
--lr 5e-5

# æˆ–å¢åŠ è®­ç»ƒepisodes
--episodes 200
```

### å¦‚æœç¢°æ’å¤ªå¤šï¼ˆ> 100ï¼‰

**å¯èƒ½åŸå› **ï¼šæ§åˆ¶è¿‡äºæ¿€è¿›

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é™ä½å­¦ä¹ ç‡
--lr 5e-6

# å‡å°clipèŒƒå›´ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰
```

### å¦‚æœé€Ÿåº¦å¤ªæ…¢ï¼ˆ< 5 m/sï¼‰

**å¯èƒ½åŸå› **ï¼šè¿‡åº¦å‡é€Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¯èƒ½éœ€è¦é‡æ–°è®­ç»ƒBCæ¨¡å‹
# æˆ–è°ƒæ•´å¥–åŠ±æƒé‡ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰
```

---

## ğŸ“ ä¸åŒé…ç½®çš„è®­ç»ƒå‘½ä»¤

### é…ç½®1: å¿«é€Ÿæµ‹è¯•ï¼ˆ10 episodesï¼‰

```bash
python train_ppo_finetune.py \
  --bc-checkpoint bc_pretrain/best_model.pt \
  --episodes 10 \
  --lr 1e-5 \
  --log-dir ./logs/ppo_test
```

**æ—¶é—´**: çº¦10-20åˆ†é’Ÿ

### é…ç½®2: æ ‡å‡†è®­ç»ƒï¼ˆ100 episodesï¼‰

```bash
python train_ppo_finetune.py \
  --bc-checkpoint bc_pretrain/best_model.pt \
  --episodes 100 \
  --lr 1e-5 \
  --log-dir ./logs/ppo_standard
```

**æ—¶é—´**: çº¦2-3å°æ—¶

### é…ç½®3: é•¿æœŸè®­ç»ƒï¼ˆ200 episodesï¼‰

```bash
python train_ppo_finetune.py \
  --bc-checkpoint bc_pretrain/best_model.pt \
  --episodes 200 \
  --lr 5e-5 \
  --log-dir ./logs/ppo_long
```

**æ—¶é—´**: çº¦5-6å°æ—¶

### é…ç½®4: è°¨æ…å¾®è°ƒï¼ˆ50 episodesï¼Œå°å­¦ä¹ ç‡ï¼‰

```bash
python train_ppo_finetune.py \
  --bc-checkpoint bc_pretrain/best_model.pt \
  --episodes 50 \
  --lr 5e-6 \
  --log-dir ./logs/ppo_conservative
```

**æ—¶é—´**: çº¦1-1.5å°æ—¶

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: è®­ç»ƒå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥GPUä½¿ç”¨ç‡
```bash
nvidia-smi
```

å¦‚æœGPUåˆ©ç”¨ç‡<50%ï¼Œå¯èƒ½éœ€è¦ï¼š
- å¢åŠ batch sizeï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰
- æ£€æŸ¥æ˜¯å¦æœ‰CPUç“¶é¢ˆ

### Q2: å¥–åŠ±ä¸€ç›´å¾ˆä½ï¼ˆ< 500ï¼‰

**A**: å¯èƒ½BCæ¨¡å‹å¤ªå·®ï¼Œå°è¯•ï¼š
```bash
# é‡æ–°è®­ç»ƒBCï¼Œä½¿ç”¨æ›´é«˜è¿‡é‡‡æ ·
python train_bc_full.py --control-weight 500
```

### Q3: è®­ç»ƒä¸­é€”å´©æºƒï¼Ÿ

**A**: æ£€æŸ¥checkpointï¼š
```bash
ls -lh ppo_finetune_checkpoints/
```

ä»æœ€è¿‘çš„checkpointæ¢å¤ï¼š
```bash
# éœ€è¦ä¿®æ”¹ä»£ç æ”¯æŒresumeåŠŸèƒ½
```

### Q4: å†…å­˜ä¸è¶³ï¼ˆCUDA OOMï¼‰

**A**: å‡å°batch sizeæˆ–max_stepsï¼š
```bash
--max-steps 1800  # å‡åŠ
```

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### Episode 1-10ï¼ˆæ¢ç´¢é˜¶æ®µï¼‰
- æ€»å¥–åŠ±: 500-1500
- OCRå¥–åŠ±: 1.5-2.5
- ç¢°æ’æƒ©ç½š: < -1.0

### Episode 10-50ï¼ˆå­¦ä¹ é˜¶æ®µï¼‰
- æ€»å¥–åŠ±: 1500-3000ï¼ˆä¸Šå‡è¶‹åŠ¿ï¼‰
- OCRå¥–åŠ±: 2.5-3.0
- ç¢°æ’æƒ©ç½š: < -0.5

### Episode 50-100ï¼ˆä¼˜åŒ–é˜¶æ®µï¼‰
- æ€»å¥–åŠ±: 3000-4000ï¼ˆç¨³å®šï¼‰
- OCRå¥–åŠ±: 2.8-3.2
- ç¢°æ’æƒ©ç½š: < -0.2
- ç¨³å®šæ€§å¥–åŠ±: > 1.2

### ç›®æ ‡æ€§èƒ½
- **æœ¬åœ°è¯„åˆ†**: > 24åˆ†
- **OCR**: > 0.93
- **å®Œæˆè½¦è¾†**: > 5800
- **ç¢°æ’**: < 50

---

## ğŸ“ è¿›é˜¶æŠ€å·§

### æŠ€å·§1: è¯¾ç¨‹å­¦ä¹ 

å…ˆè®­ç»ƒç®€å•åœºæ™¯ï¼ˆä½æµé‡ï¼‰ï¼Œå†å¢åŠ éš¾åº¦ï¼š
```bash
# é˜¶æ®µ1: ä½æµé‡é…ç½®
# é˜¶æ®µ2: æ ‡å‡†é…ç½®
# é˜¶æ®µ3: é«˜æµé‡é…ç½®
```

### æŠ€å·§2: å¥–åŠ± shaping

å¦‚æœæŸä¸ªæŒ‡æ ‡ä¸è¾¾æ ‡ï¼Œåœ¨`compute_reward()`ä¸­è°ƒæ•´æƒé‡ï¼š

```python
# ä¾‹å¦‚ï¼šå¦‚æœé€Ÿåº¦å¤ªæ…¢ï¼Œå¢å¼ºé€Ÿåº¦å¥–åŠ±
speed_reward = 5.0 * (mean_speed / 13.89) ** 2  # ä»3.0å¢åŠ åˆ°5.0

# å¦‚æœæ‹¥å µä¸¥é‡ï¼Œå¢å¼ºæ‹¥å µæƒ©ç½š
jam_penalty = -1.0 * jam_ratio  # ä»-0.5å¢åŠ åˆ°-1.0

# å¦‚æœOCRä¸è¾¾æ ‡ï¼ˆ<0.96ï¼‰ï¼Œæé«˜OCRæƒé‡
ocr_reward = 3.0 * ((current_ocr - 0.93) / (0.965 - 0.93)) ** 2  # ä»2.0å¢åŠ 
```

### æŠ€å·§3: å¤šæ¬¡è®­ç»ƒ

è®­ç»ƒå¤šä¸ªæ¨¡å‹ï¼Œé€‰æ‹©æœ€ä½³ï¼š
```bash
# è®­ç»ƒ3ä¸ªä¸åŒéšæœºç§å­
for seed in 42 123 456; do
  python train_ppo_finetune.py --seed $seed --episodes 50
done
```

---

## ğŸš¦ è®­ç»ƒæ£€æŸ¥æ¸…å•

- [ ] BCæ¨¡å‹å·²å‡†å¤‡
- [ ] æ•°æ®ç›®å½•æ­£ç¡®
- [ ] GPUå¯ç”¨ï¼ˆnvidia-smiï¼‰
- [ ] æ—¥å¿—ç›®å½•å·²åˆ›å»º
- [ ] ç£ç›˜ç©ºé—´å……è¶³ï¼ˆ>10GBï¼‰
- [ ] TensorBoardå·²å¯åŠ¨
- [ ] é¢„è®¡æ—¶é—´å·²ç¡®è®¤

å¼€å§‹è®­ç»ƒåï¼š
- [ ] æ¯10 episodesæ£€æŸ¥æ—¥å¿—
- [ ] ç›‘æ§TensorBoardæ›²çº¿
- [ ] æ£€æŸ¥GPUä½¿ç”¨ç‡
- [ ] è§‚å¯Ÿå¥–åŠ±åˆ†è§£æ˜¯å¦åˆç†

---

**æœ€åæ›´æ–°**: 2026-02-24
**ç‰ˆæœ¬**: v3.0 - æµé‡ä¼˜å…ˆå¥–åŠ±å‡½æ•°
